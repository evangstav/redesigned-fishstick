<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Strength Plan Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --md-purple-500: #673AB7; /* Primary Purple */
            --md-purple-700: #512DA8; /* Darker Purple for Headers/Accents */
            --md-purple-100: #D1C4E9; /* Lighter Purple for backgrounds/hovers */
            --md-green-500: #4CAF50;  /* Green for increases/logging */
            --md-green-700: #388E3C;
            --md-red-500: #f44336;    /* Red for decreases/danger */
            --md-red-700: #D32F2F;
            --md-grey-100: #f5f5f5;   /* Light grey for page background */
            --md-grey-300: #e0e0e0;   /* Borders */
            --md-grey-700: #616161;   /* Secondary text */
            --md-grey-900: #212121;   /* Primary text */
            --md-white: #FFFFFF;
            --md-elevation-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --md-elevation-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --md-elevation-4: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--md-grey-100); 
            color: var(--md-grey-900); 
            line-height: 1.6; 
        }
        .app-container { 
            max-width: 900px; 
            margin: 20px auto; 
            background-color: var(--md-white); 
            border-radius: 8px; 
            box-shadow: var(--md-elevation-2);
            overflow: hidden; /* To contain border-radius of children */
        }
        header { 
            background-color: var(--md-purple-700); 
            color: var(--md-white); 
            padding: 24px; 
            text-align: center; 
        }
        header h1 { 
            margin: 0; 
            font-size: 1.9em; 
            font-weight: 500;
        }
        nav { 
            display: flex; 
            justify-content: center; 
            background-color: var(--md-purple-500); 
            padding: 8px 0; 
            box-shadow: var(--md-elevation-1);
            flex-wrap: wrap;
        }
        nav button { 
            background-color: transparent; 
            color: var(--md-purple-100); 
            border: none; 
            padding: 12px 18px; 
            margin: 0; 
            border-radius: 0px; /* Flat style for tabs */
            cursor: pointer; 
            font-size: 0.98em; 
            font-weight: 500;
            text-transform: uppercase;
            transition: background-color 0.2s, color 0.2s; 
            border-bottom: 3px solid transparent;
        }
        nav button:hover { 
            background-color: rgba(255,255,255,0.1);
            color: var(--md-white);
        }
        nav button.active { 
            color: var(--md-white);
            border-bottom: 3px solid var(--md-white); /* Active tab indicator */
        }
        .content-area { padding: 24px; }
        .tab-content { display: none; } 
        .tab-content.active { display: block; } 
        .section { 
            margin-bottom: 24px; 
            padding: 20px; 
            background-color: var(--md-white); 
            border-radius: 6px; 
            border: 1px solid var(--md-grey-300);
            box-shadow: var(--md-elevation-1);
        }
        .section h2 { 
            font-size: 1.6em; 
            color: var(--md-purple-700); 
            margin-top: 0; 
            margin-bottom: 16px;
            padding-bottom: 10px; 
            border-bottom: 2px solid var(--md-purple-100); 
            font-weight: 500;
        }
        .section h3 { 
            font-size: 1.3em; 
            color: var(--md-purple-500); 
            margin-top: 20px; 
            margin-bottom: 12px;
            font-weight: 500;
        }
        .section h4 { 
            font-size: 1.1em; 
            color: var(--md-grey-900); 
            margin-top: 16px; 
            margin-bottom: 8px;
            font-weight: 500;
        }
        .section ul { padding-left: 20px; margin-bottom: 16px; }
        .section li { margin-bottom: 10px; color: var(--md-grey-700); }
        
        label { 
            display: block; 
            margin-top: 12px; 
            margin-bottom: 4px;
            font-weight: 500; 
            color: var(--md-grey-700);
            font-size: 0.9em;
        }
        input[type="text"], input[type="number"], input[type="date"], select { 
            width: 100%; 
            padding: 12px; 
            margin-top: 4px; 
            border: 1px solid var(--md-grey-300); 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 1em;
            background-color: var(--md-white);
            color: var(--md-grey-900);
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            border-color: var(--md-purple-500);
            outline: none;
            box-shadow: 0 0 0 2px var(--md-purple-100);
        }

        .inline-inputs { margin-bottom: 10px; }
        .inline-inputs label { display: inline-block; margin-right: 5px; font-weight: normal; font-size: 0.95em;}
        .inline-inputs input[type="number"], .inline-inputs input[type="text"] { 
            width: 75px; 
            display: inline-block; 
            margin-right: 12px; 
            padding: 8px;
        }
        
        button.action-button, button.log-set-button, button.danger-button {
            color: var(--md-white); 
            padding: 10px 18px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 12px; 
            font-size: 0.95em;
            font-weight: 500;
            text-transform: uppercase;
            box-shadow: var(--md-elevation-1);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        button.action-button { background-color: var(--md-purple-500); }
        button.action-button:hover { background-color: var(--md-purple-700); box-shadow: var(--md-elevation-2); }
        
        button.log-set-button { background-color: var(--md-green-500); } 
        button.log-set-button:hover { background-color: var(--md-green-700); box-shadow: var(--md-elevation-2); }
        
        button.danger-button { background-color: var(--md-red-500); } 
        button.danger-button:hover { background-color: var(--md-red-700); box-shadow: var(--md-elevation-2); }

        .exercise-item { 
            border-bottom: 1px solid var(--md-grey-300); 
            padding-bottom: 16px; 
            margin-bottom: 16px; 
        }
        .exercise-item:last-child { border-bottom: none; }
        .exercise-details { font-size: 0.95em; color: var(--md-grey-700); margin-bottom: 8px; }
        .exercise-notes { 
            font-style: normal; 
            font-size: 0.9em; 
            color: var(--md-grey-700); 
            background-color: var(--md-purple-100); 
            padding: 10px; 
            border-radius: 4px; 
            margin-top: 8px;
            border-left: 3px solid var(--md-purple-500);
        }
        
        .e1rm-manage-section table { 
            width: 100%; 
            margin-top: 16px; 
            border-collapse: collapse; 
        }
        .e1rm-manage-section th, .e1rm-manage-section td { 
            border: 1px solid var(--md-grey-300); 
            padding: 12px; 
            text-align: left; 
            font-size: 0.95em;
        }
        .e1rm-manage-section th { 
            background-color: var(--md-purple-100); 
            color: var(--md-purple-700);
            font-weight: 500;
        }
        .e1rm-manage-section td input[type="number"] {
            padding: 8px;
            font-size: 0.95em;
            max-width: 100px; /* Ensure input doesn't get too wide */
        }
        .e1rm-change-indicator.increased { color: var(--md-green-500); margin-left: 5px; font-weight: bold;}
        .e1rm-change-indicator.decreased { color: var(--md-red-500); margin-left: 5px; font-weight: bold;}


        .workout-log-entry { 
            border: 1px solid var(--md-grey-300); 
            padding: 12px; 
            margin-top: 8px; 
            border-radius: 4px; 
            background-color: var(--md-white); 
            font-size: 0.9em; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        #dailyWorkoutLogContainer { 
            max-height: 250px; 
            overflow-y: auto; 
            margin-top:16px; 
            border: 1px solid var(--md-grey-300); 
            padding:10px; 
            background-color: var(--md-grey-100);
            border-radius: 4px;
        }
        .completed-marker { color: var(--md-green-500); font-weight: bold; margin-left: 10px; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { 
            background-color: var(--md-white); 
            margin: 10% auto; 
            padding: 24px; 
            border-radius: 8px; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: var(--md-elevation-4);
            position: relative;
        }
        .close-button { 
            color: var(--md-grey-700); 
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 32px; 
            font-weight: bold; 
            cursor: pointer; 
            line-height: 1;
        }
        .close-button:hover, .close-button:focus { color: var(--md-grey-900); text-decoration: none; }
        .modal-content h3 { color: var(--md-purple-700); margin-top: 0; font-weight: 500; }
        .bodyweight-input-container { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--md-grey-300); }
        .bodyweight-input-container label { font-weight: 500; }
        .bodyweight-input-container input { max-width: 120px; display: inline-block; margin-right: 10px;}
        .metrics-input-group { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;}
        .metrics-input-group div { flex-grow: 1;}

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-container { 
                margin: 10px; 
                border-radius: 0;
                box-shadow: none;
            }
            header { padding: 16px; }
            header h1 { font-size: 1.5em; }
            nav { 
                flex-wrap: wrap; 
                padding: 4px 0;
            }
            nav button { 
                padding: 10px 12px; 
                font-size: 0.85em;
                min-width: 100px;
            }
            .content-area { padding: 16px; }
            .section { 
                padding: 16px; 
                margin-bottom: 16px;
            }
            .section h2 { font-size: 1.4em; }
            .section h3 { font-size: 1.2em; }
            
            /* Improve form inputs on mobile */
            input[type="text"], input[type="number"], input[type="date"], select { 
                padding: 14px; 
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 6px;
            }
            textarea {
                padding: 14px;
                font-size: 16px;
                border: 1px solid var(--md-grey-300);
                border-radius: 6px;
            }
            
            /* Better button sizing for touch */
            button.action-button, button.log-set-button, button.danger-button {
                padding: 12px 20px;
                font-size: 1em;
                min-height: 44px; /* iOS recommended touch target */
                margin-top: 8px;
            }
            
            /* Improve inline inputs layout */
            .inline-inputs {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 12px;
            }
            .inline-inputs label {
                display: block;
                margin-bottom: 4px;
                font-weight: 500;
            }
            .inline-inputs input[type="number"], .inline-inputs input[type="text"] {
                width: 100%;
                margin-right: 0;
                padding: 12px;
            }
            
            /* Modal improvements */
            .modal-content {
                margin: 5% auto;
                width: 95%;
                padding: 20px;
            }
            
            /* Table responsiveness */
            .e1rm-manage-section table {
                font-size: 0.9em;
            }
            .e1rm-manage-section th, .e1rm-manage-section td {
                padding: 8px;
            }
            
            /* Exercise item improvements */
            .exercise-item {
                padding-bottom: 20px;
                margin-bottom: 20px;
            }
            
            /* Metrics input group for mobile */
            .metrics-input-group {
                flex-direction: column;
                gap: 15px;
            }
            
            /* Chart container */
            #bodyweightChart {
                max-height: 250px;
            }
        }

        @media (max-width: 480px) {
            header h1 { font-size: 1.3em; }
            nav button { 
                padding: 8px 10px;
                font-size: 0.8em;
                min-width: 80px;
            }
            .content-area { padding: 12px; }
            .section { padding: 12px; }
            
            /* Stack form elements vertically on very small screens */
            .bodyweight-input-container input {
                max-width: 100%;
                margin-bottom: 10px;
            }
            
            /* Smaller modal on tiny screens */
            .modal-content {
                margin: 2% auto;
                width: 98%;
                padding: 16px;
            }
        }

        /* Landscape tablet */
        @media (min-width: 769px) and (max-width: 1024px) {
            .app-container {
                margin: 15px auto;
                max-width: 95%;
            }
            .content-area { padding: 20px; }
        }

        /* Touch-friendly improvements for all mobile devices */
        @media (hover: none) {
            button:hover {
                background-color: inherit; /* Remove hover effects on touch devices */
            }
            nav button:hover {
                background-color: rgba(255,255,255,0.1);
            }
            button.action-button:hover { background-color: var(--md-purple-500); }
            button.log-set-button:hover { background-color: var(--md-green-500); }
            button.danger-button:hover { background-color: var(--md-red-500); }
        }

        /* Rest Timer Styles */
        .rest-timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--md-white);
            border: 2px solid var(--md-purple-500);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--md-elevation-4);
            z-index: 999;
            min-width: 200px;
            text-align: center;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .rest-timer-container.active {
            transform: translateX(0);
        }
        .rest-timer-display {
            font-size: 2em;
            font-weight: bold;
            color: var(--md-purple-700);
            margin: 10px 0;
            font-family: 'Roboto Mono', monospace;
        }
        .rest-timer-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .rest-timer-controls button {
            padding: 6px 12px;
            font-size: 0.85em;
            min-height: auto;
        }
        .timer-preset-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .timer-preset-buttons button {
            padding: 4px 8px;
            font-size: 0.75em;
            background-color: var(--md-grey-300);
            color: var(--md-grey-900);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .timer-preset-buttons button:hover {
            background-color: var(--md-grey-700);
            color: var(--md-white);
        }

        @media (max-width: 768px) {
            .rest-timer-container {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
                padding: 12px;
            }
            .rest-timer-display {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>My Training Plan</h1>
        </header>
        <nav id="mainNav">
            <button data-tab="guideTab" onclick="showTab('guideTab')">Guide</button>
            <button data-tab="smartRecommendationsTab" onclick="showTab('smartRecommendationsTab')">Smart Recommendations</button>
            <button data-tab="progressTab" onclick="showTab('progressTab')">Progress</button>
            <button data-tab="e1rmTab" onclick="showTab('e1rmTab')">Settings &amp; e1RMs</button>
        </nav>
        <div class="content-area">
            <div id="guideTab" class="tab-content section">
                <h2>Program Guide</h2>
                <p>Welcome to your personalized strength and conditioning plan tracker! This guide will help you understand how to use the app and follow the program effectively.</p>

                <h4>Core Principles:</h4>
                <ul>
                    <li><strong>Consistency is Key:</strong> Adherence to the plan over time will yield the best results. Show up and do the work.</li>
                    <li><strong>Progressive Overload:</strong> The program is designed to help you gradually get stronger. This app helps by:
                        <ul>
                            <li>Calculating target weights based on your e1RM.</li>
                            <li>Autoregulating your e1RM based on your performance (especially on heavy single sets). Aim to improve weight, reps, or perform sets at a lower RPE over time.</li>
                        </ul>
                    </li>
                    <li><strong>RPE (Rating of Perceived Exertion):</strong>
                        <ul>
                            <li>Scale of 1-10, where 10 is maximal effort (0 reps left), 9 is 1 rep left (RIR 1), 8 is 2 reps left (RIR 2), etc.</li>
                            <li>Use RPE honestly to guide your effort and help the app adjust your e1RM.</li>
                            <li>Your plan often specifies target RPEs for activation and top sets (e.g., RPE 8-9).</li>
                        </ul>
                    </li>
                    <li><strong>e1RM (Estimated 1 Rep Max):</strong>
                        <ul>
                            <li>This is an estimate of the maximum weight you can lift for one repetition.</li>
                            <li>Set your initial e1RMs and Bodyweight in the "Settings &amp; e1RMs" tab.</li>
                            <li>The app updates your e1RM for main lifts after you log "Activation Sets" and "Main Top Sets". The highest calculated e1RM from these sets in a session becomes your new e1RM for that lift.</li>
                            <li>Accessory lifts that are also in the `CORE_LIFTS_IN_PLAN` list can also have their e1RMs updated if a logged set represents a new PR.</li>
                            <li>For bodyweight exercises like Dips and Weighted Pull-ups, the weight you log is *added weight*. The app uses your set bodyweight + added weight to calculate the e1RM (total load).</li>
                        </ul>
                    </li>
                </ul>

                <h4>Workout Structure:</h4>
                <ul>
                    <li><strong>Activation Sets (&gt;90% 1RM):</strong> Perform 1 set of 3-5 reps. These prepare you for heavy lifting, allow practice with heavy loads, and contribute to e1RM updates.</li>
                    <li><strong>Main Top Sets (e.g., 1x4 @ 88%):</strong> Your primary strength-building set for the main compound lifts. These also significantly contribute to e1RM updates.</li>
                    <li><strong>Volume Sets (e.g., 3x6 @ 78%):</strong> Build muscle mass and work capacity. Target weights are based on the e1RM at the start of the session.</li>
                    <li><strong>Accessory Lifts:</strong> Target specific muscle groups and support your main lifts. Aim for the prescribed reps/sets and an appropriate RPE (often 7-9).</li>
                    <li><strong>Cardio (HIIT &amp; Zone 2):</strong> Crucial for cardiovascular health (VO<sub>2</sub>max) and endurance.
                        <ul>
                            <li>HIIT (e.g., Norwegian 4x4): Intense intervals.</li>
                            <li>Zone 2: Longer, steady-state cardio at a conversational pace (~70% HRmax or RPE 9-12).</li>
                        </ul>
                    </li>
                    <li><strong>Mobility:</strong> Focus on dynamic movements. Resistance training itself helps maintain flexibility.</li>
                </ul>

                <h4>Warm-ups &amp; Rest:</h4>
                <ul>
                    <li><strong>Warm-ups:</strong> Perform dynamic, lift-specific warm-ups. Your plan mentions mini-band glute activation (Mon) and shoulder ER (Tue). One or two ramp-up sets for main lifts usually suffice.</li>
                    <li><strong>Rest Periods:</strong>
                        <ul>
                            <li>After Activation/Main Top Sets: 2-5 minutes.</li>
                            <li>Between Volume Sets: 2-3 minutes.</li>
                            <li>Between Accessory Sets: As needed, typically 60-120 seconds.</li>
                        </ul>
                    </li>
                </ul>
                <h4>Nutrition &amp; Lifestyle (From Your Plan):</h4>
                <ul>
                    <li><strong>Protein:</strong> 1.6–2.2 g/kg/day (≥ 0.4 g/kg/meal).</li>
                    <li><strong>Creatine Monohydrate:</strong> 3–5 g daily.</li>
                    <li><strong>Omega‑3:</strong> Load 4 wks @ 3g EPA + 2g DHA, then ~2g total daily.</li>
                    <li><strong>Calorie Balance:</strong> For recomp, maintain ≈10‑15 % kcal deficit with high protein.</li>
                    <li><strong>Sleep:</strong> 7–9 hours; crucial for recovery and body composition.</li>
                </ul>

                <h4>How to Use This App:</h4>
                <ol>
                    <li><strong>Set Initial e1RMs &amp; Bodyweight:</strong> Go to the "Settings &amp; e1RMs" tab. Input your current bodyweight and estimated 1 Rep Max for all listed exercises. Click "Save All Settings &amp; e1RMs". This is crucial for the app to calculate your target weights and track bodyweight exercises accurately.</li>
                    <li><strong>Choose Your Workout:</strong> Click any workout type in the top navigation (e.g., "Squat Day", "Bench Day", "Deadlift Day"). You can do these workouts on any day of the week that works for your schedule. <em>NEW: Use the "Smart Recommendations" tab to get AI-powered workout suggestions based on how you're feeling and your recent training history!</em></li>
                    <li><strong>Perform &amp; Log:</strong>
                        <ul>
                            <li>For each exercise, the app will show target weights (if applicable).</li>
                            <li>For bodyweight exercises like Dips and Pull-ups, the "Actual Wt" field in the modal refers to *added weight*.</li>
                            <li>After performing a set, enter the actual weight lifted (or added weight), reps performed, and RPE achieved.</li>
                            <li>Click the "Log Set" button.</li>
                            <li>For multi-set accessory exercises, a modal will appear for logging each set.</li>
                            <li>For mobility/cardio, click "Mark Completed".</li>
                        </ul>
                    </li>
                    <li><strong>Track Progress:</strong> Visit the "Progress" tab to see your bodyweight graph and weekly workout days logged.</li>
                    <li><strong>Review:</strong> Check "Today's Log" to see your completed activities and any e1RM updates. Your e1RMs in the "Settings &amp; e1RMs" tab will also reflect changes.</li>
                </ol>
                
                <h4>Workout Types:</h4>
                <ul>
                    <li><strong>Squat Day:</strong> Focus on back squats with hip thrust accessory work</li>
                    <li><strong>Bench Day:</strong> Bench press with overhead press and dips</li>
                    <li><strong>Deadlift Day:</strong> Deadlifts with Romanian deadlift accessory work</li>
                    <li><strong>Pull Day:</strong> Weighted pull-ups, rows, and HIIT cardio</li>
                    <li><strong>Cardio Day:</strong> Zone 2 cardiovascular training</li>
                    <li><strong>Mobility Day:</strong> Dynamic movement and flexibility work</li>
                    <li><strong>Rest Day:</strong> Light mobility and recovery</li>
                </ul>
                <p><em>This app uses your browser's local storage to save data. It will persist as long as you use the same browser and don't clear its site data.</em></p>
            </div>

            <div id="smartRecommendationsTab" class="tab-content section">
                <h2>Smart Workout Recommendations</h2>
                <p>Get AI-powered workout recommendations based on your training history, current fitness level, and how you're feeling today.</p>
                
                <div class="section">
                    <h3>How are you feeling today?</h3>
                    <div style="margin-bottom: 15px;">
                        <label for="energyLevel">Energy Level (1-10):</label>
                        <input type="range" id="energyLevel" min="1" max="10" value="7" style="width: 100%; margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: var(--md-grey-700);">
                            <span>Very Low</span>
                            <span id="energyLevelValue">7</span>
                            <span>Very High</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="stressLevel">Stress Level (1-10):</label>
                        <input type="range" id="stressLevel" min="1" max="10" value="5" style="width: 100%; margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: var(--md-grey-700);">
                            <span>Very Low</span>
                            <span id="stressLevelValue">5</span>
                            <span>Very High</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="musclesSore">Any muscle soreness or fatigue?</label>
                        <textarea id="musclesSore" placeholder="e.g., legs still sore from yesterday's squat session, feeling fresh overall, shoulders tight..." style="width: 100%; padding: 10px; border: 1px solid var(--md-grey-300); border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="timeAvailable">Time available (minutes):</label>
                        <input type="number" id="timeAvailable" value="60" min="15" max="180" style="width: 100px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="specificGoals">Specific goals for today (optional):</label>
                        <textarea id="specificGoals" placeholder="e.g., want to focus on upper body, need a lighter day, want to push hard today..." style="width: 100%; padding: 10px; border: 1px solid var(--md-grey-300); border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>
                    
                    <button class="action-button" onclick="getWorkoutRecommendation()" id="getRecommendationBtn">Get AI Recommendation</button>
                    <button class="action-button" onclick="generateSimpleRecommendation()" style="margin-left: 10px;">Get Quick Recommendation</button>
                </div>
                
                <div id="recommendationResult" class="section" style="display: none;">
                    <h3>Your Recommended Workout</h3>
                    <div id="recommendationContent"></div>
                    <button class="action-button" onclick="acceptRecommendation()" id="acceptRecommendationBtn" style="margin-top: 15px;">Start This Workout</button>
                </div>
            </div>

            <div id="workoutDayTab" class="tab-content">
                <div id="workoutDisplayArea" class="section">
                    <h2 id="workoutDayTitle">Select a day</h2>
                    {/* Workout items will be populated here by JavaScript */}
                </div>

                <div class="section">
                    <h2>Today's Log (<span id="currentDateDisplay"></span>)</h2>
                    <div id="dailyWorkoutLogContainer"></div>
                    <button class="danger-button" onclick="clearDailyLog()" style="margin-top:10px;">Clear Today's Log</button>
                </div>
            </div>
            
            <div id="progressTab" class="tab-content section">
                <h2>Progress &amp; Metrics</h2>
                <div class="section">
                    <h3>Attendance</h3>
                    <p id="attendanceSummary">Workout days this week: 0</p>
                </div>
                <div class="section">
                    <h3>Bodyweight Tracking</h3>
                    <div class="metrics-input-group">
                        <div>
                            <label for="logBodyweightDate">Date:</label>
                            <input type="date" id="logBodyweightDate">
                        </div>
                        <div>
                            <label for="logBodyweightValue">Bodyweight (kg/lbs):</label>
                            <input type="number" id="logBodyweightValue" placeholder="e.g., 70.5">
                        </div>
                        <button class="action-button" onclick="logBodyweightEntryFromInput()" style="align-self: flex-end; margin-bottom:0; padding: 12px 18px;">Log BW Entry</button>
                    </div>
                    <canvas id="bodyweightChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div id="e1rmTab" class="tab-content section e1rm-manage-section">
                <h2>Settings &amp; e1RMs</h2>
                <div class="bodyweight-input-container">
                    <label for="currentBodyweight">Current Bodyweight for Calculations (kg/lbs):</label>
                    <input type="number" id="currentBodyweight" placeholder="e.g., 70">
                    <span style="font-size:0.85em; color: var(--md-grey-700); display:block; margin-top:4px;">This is used for e1RM calculations on bodyweight exercises. Log historical bodyweight in the 'Progress' tab.</span>
                </div>
                <div class="bodyweight-input-container">
                    <label for="claudeApiKey">Claude API Key (Optional - for workout recommendations):</label>
                    <input type="password" id="claudeApiKey" placeholder="sk-ant-...">
                    <div style="margin-top: 8px;">
                        <button class="action-button" onclick="saveClaudeApiKey()" style="padding: 8px 12px; font-size: 0.9em; margin-right: 8px;">Save API Key</button>
                        <button class="action-button" onclick="testClaudeApiKey()" style="padding: 8px 12px; font-size: 0.9em;">Test API Key</button>
                    </div>
                    <span style="font-size:0.85em; color: var(--md-grey-700); display:block; margin-top:4px;">Enter your Claude API key to enable AI-powered workout recommendations based on your history and how you're feeling.</span>
                    <div id="apiKeyStatus" style="font-size: 0.85em; margin-top: 4px;"></div>
                </div>
                <div class="bodyweight-input-container">
                    <h3>Data Management</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="action-button" onclick="exportData()">Export All Data</button>
                        <button class="action-button" onclick="document.getElementById('importFile').click()">Import Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                    <div id="dataManagementStatus" style="font-size: 0.9em; color: var(--md-grey-700); margin-bottom: 10px;"></div>
                </div>
                
                <h3>Manage e1RMs (kg/lbs)</h3>
                <table>
                    <thead><tr><th>Exercise</th><th>Current e1RM <span style="font-size:0.8em; font-weight:normal;">(Change)</span></th><th>New e1RM (Editable)</th></tr></thead>
                    <tbody id="e1rmTableBody"></tbody>
                </table>
                <button id="saveAllE1RMsButton" class="action-button" onclick="saveAllSettingsAndE1RMs()">Save All Settings &amp; e1RMs</button>
            </div>
        </div>
    </div>

    <div id="accessoryLogModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Log Accessory Set</h3>
            <input type="hidden" id="modalExerciseName">
            <input type="hidden" id="modalSetIndex">
            <label for="modalWeight" id="modalWeightLabel">Weight:</label>
            <input type="number" id="modalWeight" placeholder="Weight">
            <label for="modalReps">Reps:</label>
            <input type="number" id="modalReps" placeholder="Reps">
            <label for="modalRPE">RPE (6-10):</label>
            <input type="number" id="modalRPE" step="0.5" min="6" max="10" placeholder="RPE">
            <button class="action-button" onclick="submitAccessorySetLog()">Log Set</button>
        </div>
    </div>

    <!-- Rest Timer -->
    <div id="restTimer" class="rest-timer-container">
        <div style="font-size: 0.9em; font-weight: 500; margin-bottom: 8px;">Rest Timer</div>
        <div class="timer-preset-buttons">
            <button onclick="startRestTimer(60)">1m</button>
            <button onclick="startRestTimer(90)">1.5m</button>
            <button onclick="startRestTimer(120)">2m</button>
            <button onclick="startRestTimer(180)">3m</button>
            <button onclick="startRestTimer(300)">5m</button>
        </div>
        <div class="rest-timer-display" id="timerDisplay">0:00</div>
        <div class="rest-timer-controls">
            <button class="action-button" onclick="startRestTimer()" id="startTimerBtn">Start</button>
            <button class="action-button" onclick="pauseRestTimer()" id="pauseTimerBtn">Pause</button>
            <button class="action-button" onclick="stopRestTimer()" id="stopTimerBtn">Stop</button>
            <button class="action-button" onclick="toggleRestTimer()" id="toggleTimerBtn">Hide</button>
        </div>
        <div style="margin-top: 8px;">
            <input type="number" id="customTimerMinutes" placeholder="Minutes" style="width: 60px; padding: 4px; font-size: 0.8em;" min="0" max="60">
            <button class="action-button" onclick="startCustomTimer()" style="padding: 4px 8px; font-size: 0.8em;">Set</button>
        </div>
    </div>

    <script>
        // RPE to Reps In Reserve mapping
        const RPE_TO_RIR = { 10: 0, 9.5: 0.5, 9: 1, 8.5: 1.5, 8: 2, 7.5: 2.5, 7: 3, 6.5: 3.5, 6: 4 };
        // Core lifts for which e1RM will be tracked
        const CORE_LIFTS_IN_PLAN = ["Back-squat", "Bench Press", "Deadlift", "OHP", "Weighted Pull-up", "Hip-thrust", "RDL", "Dips", "Chest-supported Row"];
        const BODYWEIGHT_ASSISTED_EXERCISES = ["Weighted Pull-up", "Dips"]; 

        // The user's workout plan structure - reorganized by workout type
        const USER_WORKOUT_PLAN = {
            "Squat Day": [
                { id:"squat_activation", type: "strength_single_heavy", liftName: "Back-squat", sets: 1, repsTarget: 3, percentage: 0.92, group:"Back-squat", setLabel: "Activation Set (>90% 1RM)", notes: "Warm-up: Mini-band glute activation. Aim for 3-5 reps. RPE ~8.5-9.5. This set contributes to e1RM." },
                { id:"squat_top", type: "strength_single_heavy", liftName: "Back-squat", sets: 1, repsTarget: 4, percentage: 0.88, group:"Back-squat", setLabel: "Main Top Set", notes: "Rest 2-5 min after this set. Aim for RPE ~8-9. This set contributes to e1RM." },
                { id:"squat_vol", type: "strength_volume", liftName: "Back-squat", sets: 3, reps: 6, percentage: 0.78, group:"Back-squat", notes: "Rest 2-3 min between sets." },
                { id:"squat_ht", type: "accessory", liftName: "Hip-thrust", sets: 4, reps: 8, notes: "Aim for RPE 7-9." }
            ],
            "Bench Day": [
                { id:"bench_activation", type: "strength_single_heavy", liftName: "Bench Press", sets: 1, repsTarget: 3, percentage: 0.92, group:"Bench Press", setLabel: "Activation Set (>90% 1RM)", notes: "Warm-up: Shoulder ER. Aim for 3-5 reps. RPE ~8.5-9.5. This set contributes to e1RM." },
                { id:"bench_top", type: "strength_single_heavy", liftName: "Bench Press", sets: 1, repsTarget: 4, percentage: 0.88, group:"Bench Press", setLabel: "Main Top Set", notes: "Rest 2-5 min after this set. Aim for RPE ~8-9. This set contributes to e1RM." },
                { id:"bench_vol", type: "strength_volume", liftName: "Bench Press", sets: 3, reps: 6, percentage: 0.78, group:"Bench Press", notes: "Rest 2-3 min between sets." },
                { id:"bench_ohp", type: "accessory", liftName: "OHP", sets: 3, reps: 6, notes: "Aim for RPE 7-9. This lift also uses e1RM." },
                { id:"bench_dips", type: "accessory", liftName: "Dips", sets: 3, reps: 10, notes: "Aim for RPE 7-9, or near failure if appropriate. Log ADDED weight." }
            ],
            "Deadlift Day": [
                { id:"deadlift_activation", type: "strength_single_heavy", liftName: "Deadlift", sets: 1, repsTarget: 3, percentage: 0.92, group:"Deadlift", setLabel: "Activation Set (>90% 1RM)", notes: "Aim for 3-5 reps. RPE ~8.5-9.5. This set contributes to e1RM." },
                { id:"deadlift_top", type: "strength_single_heavy", liftName: "Deadlift", sets: 1, repsTarget: 3, percentage: 0.90, group:"Deadlift", setLabel: "Main Top Set", notes: "Rest 2-5 min after this set. Aim for RPE ~8-9. This set contributes to e1RM." },
                { id:"deadlift_vol", type: "strength_volume", liftName: "Deadlift", sets: 3, reps: 6, percentage: 0.80, group:"Deadlift", notes: "Rest 2-3 min between sets." },
                { id:"deadlift_rdl", type: "accessory", liftName: "RDL", sets: 3, reps: 8, notes: "Aim for RPE 7-9." }
            ],
            "Pull Day": [
                { id:"pull_hiit", type: "hiit", name: "Norwegian 4x4", details: "4 min @ 85-95% HRmax / 3 min active recovery @ ~70% HRmax, x4 repeats. Total duration approx 38-40min incl warm-up/cool-down.", notes: "Optional: 10-min HIIT (10x60s @ 90% HRmax / 60s easy) every 2-3 weeks for variety. Largest VO2-max gains." },
                { id:"pull_pullup", type: "accessory", liftName: "Weighted Pull-up", sets: 3, repsRange: "6-8", notes: "Aim for RPE 8-9. This lift uses e1RM. Log ADDED weight." },
                { id:"pull_row", type: "accessory", liftName: "Chest-supported Row", sets: 3, reps: 10, notes: "Aim for RPE 7-9." }
            ],
            "Cardio Day": [ 
                { id:"cardio_z2", type: "cardio", name: "Zone 2 Run", duration: "40-45 min", intensity: "~70% HRmax or RPE 9-12 (able to speak in sentences).", notes: "Consider extending to 60+ min for enhanced heart health benefits. Dynamic mobility is enough; resistance training itself maintains flexibility." } 
            ],
            "Mobility Day": [ 
                { id:"mobility_flow", type: "mobility", name: "Mobility Flow", notes: "Dynamic movements. Static stretching generally not needed if resistance training covers range of motion. Refer to §5 of your plan." } 
            ],
            "Rest Day": [ 
                { id:"rest_mobility", type: "mobility", name: "Rest + Short Mobility", notes: "Focus on recovery. Gentle movements." } 
            ]
        };

        // Global state variables
        let exercisesE1RM = {}; 
        let e1RMChangeStatus = {}; 
        let userBodyweight = 0; 
        let bodyweightHistory = []; // Array of {date: "YYYY-MM-DD", weight: number}
        let dailyLog = {};      
        let currentSelectedDayKey = null; 
        let currentActiveTab = 'guideTab'; 
        const APP_VERSION_KEY = 'v4_material_bw_graph'; // Updated version key
        const todayKey = new Date().toISOString().split('T')[0]; 
        let bodyweightChartInstance = null;
        let claudeApiKey = '';
        let currentRecommendation = null;
        
        // Rest Timer Variables
        let restTimerInterval = null;
        let restTimerSeconds = 0;
        let restTimerTotalSeconds = 0;
        let restTimerPaused = false;


        // Epley formula for e1RM calculation
        function calculateEpleyE1RM(weight, reps) {
            if (reps === 0 || weight === 0) return 0; 
            if (reps === 1) return weight; 
            return weight * (1 + (reps / 30));
        }

        // Calculates effective reps based on actual reps and RPE (using RIR)
        function getEffectiveReps(actualReps, actualRPE) {
            let effectiveReps = parseFloat(actualReps);
            if (RPE_TO_RIR.hasOwnProperty(actualRPE)) {
                effectiveReps += RPE_TO_RIR[actualRPE];
            } else if (actualRPE < 6) { 
                effectiveReps += (10 - actualRPE);
            }
            return effectiveReps;
        }
        
        // Enhanced error handling with user feedback
        function showError(message, details = '') {
            console.error('App Error:', message, details);
            const alertMessage = `Error: ${message}${details ? '\n\nDetails: ' + details : ''}`;
            alert(alertMessage);
        }

        function showSuccess(message) {
            console.log('Success:', message);
            // Could be enhanced with a toast notification system
        }

        // Load data from localStorage with error handling
        function loadData() {
            try {
                const storedE1RMs = localStorage.getItem(`personalizedPlanE1RMs_${APP_VERSION_KEY}`); 
                if (storedE1RMs) {
                    exercisesE1RM = JSON.parse(storedE1RMs);
                    // Validate loaded data
                    if (typeof exercisesE1RM !== 'object' || exercisesE1RM === null) {
                        throw new Error('Invalid e1RM data format');
                    }
                } else { 
                    CORE_LIFTS_IN_PLAN.forEach(lift => exercisesE1RM[lift] = 0); 
                }
            } catch (error) {
                showError('Failed to load e1RM data', error.message);
                CORE_LIFTS_IN_PLAN.forEach(lift => exercisesE1RM[lift] = 0);
            }
            
            try {
                const storedChangeStatus = localStorage.getItem(`personalizedPlanE1RMChangeStatus_${APP_VERSION_KEY}`);
                if (storedChangeStatus) {
                    e1RMChangeStatus = JSON.parse(storedChangeStatus);
                } else {
                    e1RMChangeStatus = {};
                }
            } catch (error) {
                showError('Failed to load e1RM change status', error.message);
                e1RMChangeStatus = {};
            }

            try {
                const storedBodyweight = localStorage.getItem(`personalizedPlanBodyweight_${APP_VERSION_KEY}`);
                if (storedBodyweight) {
                    userBodyweight = parseFloat(storedBodyweight);
                    if (isNaN(userBodyweight) || userBodyweight <= 0) {
                        throw new Error('Invalid bodyweight value');
                    }
                    document.getElementById('currentBodyweight').value = userBodyweight;
                }
            } catch (error) {
                showError('Failed to load bodyweight', error.message);
                userBodyweight = 0;
            }

            try {
                const storedBwHistory = localStorage.getItem(`personalizedPlanBwHistory_${APP_VERSION_KEY}`);
                if (storedBwHistory) {
                    bodyweightHistory = JSON.parse(storedBwHistory);
                    if (!Array.isArray(bodyweightHistory)) {
                        throw new Error('Invalid bodyweight history format');
                    }
                } else {
                    bodyweightHistory = [];
                }
            } catch (error) {
                showError('Failed to load bodyweight history', error.message);
                bodyweightHistory = [];
            }

            try {
                const storedApiKey = localStorage.getItem(`personalizedPlanClaudeApiKey_${APP_VERSION_KEY}`);
                if (storedApiKey) {
                    claudeApiKey = storedApiKey;
                    document.getElementById('claudeApiKey').value = claudeApiKey;
                }
            } catch (error) {
                showError('Failed to load API key', error.message);
                claudeApiKey = '';
            }

            try {
                const storedDailyLog = localStorage.getItem(`personalizedPlanDailyLog_${APP_VERSION_KEY}_${todayKey}`); 
                if (storedDailyLog) {
                    dailyLog = JSON.parse(storedDailyLog);
                    if (typeof dailyLog !== 'object' || dailyLog === null) {
                        throw new Error('Invalid daily log format');
                    }
                } else {
                    dailyLog = {}; 
                }
            } catch (error) {
                showError('Failed to load daily log', error.message);
                dailyLog = {};
            }
        }

        // Save data to localStorage with error handling
        function saveData() {
            try {
                localStorage.setItem(`personalizedPlanE1RMs_${APP_VERSION_KEY}`, JSON.stringify(exercisesE1RM));
                localStorage.setItem(`personalizedPlanE1RMChangeStatus_${APP_VERSION_KEY}`, JSON.stringify(e1RMChangeStatus));
                localStorage.setItem(`personalizedPlanBodyweight_${APP_VERSION_KEY}`, userBodyweight.toString());
                localStorage.setItem(`personalizedPlanBwHistory_${APP_VERSION_KEY}`, JSON.stringify(bodyweightHistory));
                localStorage.setItem(`personalizedPlanClaudeApiKey_${APP_VERSION_KEY}`, claudeApiKey);
                localStorage.setItem(`personalizedPlanDailyLog_${APP_VERSION_KEY}_${todayKey}`, JSON.stringify(dailyLog));
            } catch (error) {
                showError('Failed to save data', error.message + '. Your data may not be preserved.');
            }
        }
        
        // Saves the current bodyweight from the settings tab and logs it.
        function saveCurrentBodyweightAndLog() {
            const bwInput = document.getElementById('currentBodyweight');
            const newBw = parseFloat(bwInput.value);
            if (!isNaN(newBw) && newBw > 0) {
                userBodyweight = newBw;
                logBodyweightEntry(todayKey, newBw, false); // Log it, don't show alert from here
                // saveData() will be called by saveAllSettingsAndE1RMs
            } else {
                // Don't alert here, saveAllSettingsAndE1RMs will handle general save.
            }
        }
        
        // Logs a bodyweight entry from the Progress tab
        function logBodyweightEntryFromInput() {
            const dateInput = document.getElementById('logBodyweightDate').value;
            const weightInput = parseFloat(document.getElementById('logBodyweightValue').value);

            if (!dateInput) {
                alert("Please select a date.");
                return;
            }
            if (isNaN(weightInput) || weightInput <= 0) {
                alert("Please enter a valid bodyweight.");
                return;
            }
            logBodyweightEntry(dateInput, weightInput, true);
            document.getElementById('logBodyweightValue').value = ''; // Clear input
        }

        // Core function to log bodyweight, updates history and chart
        function logBodyweightEntry(date, weight, showAlert = true) {
            // Remove any existing entry for the same date to avoid duplicates, then add new one
            bodyweightHistory = bodyweightHistory.filter(entry => entry.date !== date);
            bodyweightHistory.push({ date: date, weight: parseFloat(weight) });
            bodyweightHistory.sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort by date

            // If this is today's date, also update the current userBodyweight
            if (date === todayKey) {
                userBodyweight = parseFloat(weight);
                document.getElementById('currentBodyweight').value = userBodyweight;
            }
            
            saveData();
            renderBodyweightChart();
            if (showAlert) alert(`Bodyweight for ${date} logged as ${weight}.`);
        }

        // Renders the bodyweight chart
        function renderBodyweightChart() {
            const ctx = document.getElementById('bodyweightChart');
            if (!ctx) return; // If tab not visible or element not found

            if (bodyweightChartInstance) {
                bodyweightChartInstance.destroy(); // Destroy previous instance to avoid conflicts
            }
            if (bodyweightHistory.length === 0) {
                 ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height); // Clear canvas
                 // Optionally display a message like "No bodyweight data logged yet."
                return;
            }

            const labels = bodyweightHistory.map(entry => entry.date);
            const data = bodyweightHistory.map(entry => entry.weight);
            const root = getComputedStyle(document.documentElement);
            const lineColour = root.getPropertyValue('--md-purple-500').trim() || '#673AB7';
            const bgColour   = root.getPropertyValue('--md-purple-100').trim() || '#D1C4E9';

            bodyweightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bodyweight (kg/lbs)',
                        data: data,
                        borderColor: 'var(--md-purple-500)',
                        backgroundColor: 'var(--md-purple-100)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: false // Adjust as needed, true if BW can't be very low
                        }
                    }
                }
            });
        }
        
        // Updates the attendance summary
        function updateAttendanceSummary() {
            const summaryElement = document.getElementById('attendanceSummary');
            if (!summaryElement) return;

            let loggedThisWeek = 0;
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 (Sun) - 6 (Sat)
            // Adjust to make Monday the start of the week (if Sunday is 0)
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // Monday
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Sunday
            endOfWeek.setHours(23, 59, 59, 999);

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`personalizedPlanDailyLog_${APP_VERSION_KEY}_`)) {
                    const dateStr = key.substring(`personalizedPlanDailyLog_${APP_VERSION_KEY}_`.length);
                    const logDate = new Date(dateStr + "T00:00:00"); // Ensure parsing as local date

                    if (logDate >= startOfWeek && logDate <= endOfWeek) {
                        const logContent = JSON.parse(localStorage.getItem(key));
                        if (Object.keys(logContent).length > 0) { // If any activity logged for that day
                            loggedThisWeek++;
                        }
                    }
                }
            }
            summaryElement.textContent = `Workout days this week: ${loggedThisWeek}`;
        }


        // Renders the e1RM management table
        function renderE1RMTable() {
            const tbody = document.getElementById('e1rmTableBody');
            tbody.innerHTML = ''; 
            CORE_LIFTS_IN_PLAN.forEach(liftName => {
                const row = tbody.insertRow();
                row.insertCell().textContent = liftName;
                
                const currentE1RMCell = row.insertCell();
                const currentE1RM = exercisesE1RM[liftName] || 0;
                currentE1RMCell.textContent = currentE1RM.toFixed(1);
                
                if (e1RMChangeStatus[liftName]) {
                    const indicatorSpan = document.createElement('span');
                    indicatorSpan.classList.add('e1rm-change-indicator');
                    if (e1RMChangeStatus[liftName] === "increased") {
                        indicatorSpan.textContent = " ↑";
                        indicatorSpan.classList.add('increased');
                    } else if (e1RMChangeStatus[liftName] === "decreased") {
                        indicatorSpan.textContent = " ↓";
                        indicatorSpan.classList.add('decreased');
                    }
                    currentE1RMCell.appendChild(indicatorSpan);
                }
                
                const inputCell = row.insertCell();
                const input = document.createElement('input');
                input.type = 'number';
                input.value = currentE1RM.toFixed(1); 
                input.setAttribute('data-lift', liftName);
                inputCell.appendChild(input);
            });
        }
        
        // Saves just the Claude API key
        function saveClaudeApiKey() {
            const apiKeyInput = document.getElementById('claudeApiKey');
            claudeApiKey = apiKeyInput.value.trim();
            localStorage.setItem(`personalizedPlanClaudeApiKey_${APP_VERSION_KEY}`, claudeApiKey);
            
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.textContent = 'API key saved!';
            statusDiv.style.color = 'var(--md-green-500)';
        }

        // Test the Claude API key
        async function testClaudeApiKey() {
            const apiKeyInput = document.getElementById('claudeApiKey');
            const statusDiv = document.getElementById('apiKeyStatus');
            
            const tempKey = apiKeyInput.value.trim();
            if (!tempKey) {
                statusDiv.textContent = 'Please enter an API key first';
                statusDiv.style.color = 'var(--md-red-500)';
                return;
            }

            if (!tempKey.startsWith('sk-ant-')) {
                statusDiv.textContent = 'Invalid API key format. Should start with "sk-ant-"';
                statusDiv.style.color = 'var(--md-red-500)';
                return;
            }

            statusDiv.textContent = 'Testing API key...';
            statusDiv.style.color = 'var(--md-grey-700)';

            // Temporarily set the key for testing
            const originalKey = claudeApiKey;
            claudeApiKey = tempKey;

            try {
                const result = await testApiKey();
                if (result.valid) {
                    statusDiv.textContent = '✓ API key is valid and working!';
                    statusDiv.style.color = 'var(--md-green-500)';
                } else {
                    statusDiv.textContent = `✗ ${result.message}`;
                    statusDiv.style.color = 'var(--md-red-500)';
                }
            } catch (error) {
                statusDiv.textContent = `✗ Test failed: ${error.message}`;
                statusDiv.style.color = 'var(--md-red-500)';
            }

            // Restore original key
            claudeApiKey = originalKey;
        }

        // Saves all e1RMs and current bodyweight from the editable fields in the table
        function saveAllSettingsAndE1RMs() {
            // Save e1RMs
            const inputs = document.querySelectorAll('#e1rmTableBody input[data-lift]');
            inputs.forEach(input => {
                const liftName = input.getAttribute('data-lift');
                const newE1RM = parseFloat(input.value);
                const oldE1RM = exercisesE1RM[liftName] || 0;

                if (!isNaN(newE1RM) && newE1RM >= 0) { 
                    exercisesE1RM[liftName] = newE1RM;
                    if (newE1RM > oldE1RM) {
                        e1RMChangeStatus[liftName] = "increased";
                    } else if (newE1RM < oldE1RM) {
                        e1RMChangeStatus[liftName] = "decreased";
                    } else {
                        delete e1RMChangeStatus[liftName]; 
                    }
                }
            });
            
            // Save current bodyweight and log it for today
            const bwInput = document.getElementById('currentBodyweight');
            const newBw = parseFloat(bwInput.value);
            if (!isNaN(newBw) && newBw > 0) {
                userBodyweight = newBw;
                logBodyweightEntry(todayKey, newBw, false); // Log it for history, no separate alert
            } else if (bwInput.value.trim() !== "") { 
                // only alert if user tried to input something invalid, not if it was blank
                alert("Invalid bodyweight entered. Bodyweight not saved.");
            }

            // Save Claude API key
            const apiKeyInput = document.getElementById('claudeApiKey');
            claudeApiKey = apiKeyInput.value.trim();

            saveData(); 
            renderE1RMTable(); 
            if (currentActiveTab === 'workoutDayTab' && currentSelectedDayKey) {
                 displayWorkoutForDay(currentSelectedDayKey);
            }
            alert('Settings & e1RMs saved!');
        }

        // General function to show a tab and hide others
        function showTab(tabId) {
            currentActiveTab = tabId;
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('#mainNav button').forEach(btn => {
                btn.classList.remove('active'); 
            });

            const activeNavButton = document.querySelector(`#mainNav button[data-tab='${tabId}']:not([data-day-key])`);
            if (activeNavButton) { 
                activeNavButton.classList.add('active');
            } else if (tabId === 'workoutDayTab' && currentSelectedDayKey) { 
                const activeDayButton = document.querySelector(`#mainNav button[data-day-key="${currentSelectedDayKey}"]`);
                if (activeDayButton) activeDayButton.classList.add('active');
            }

            if (tabId === 'progressTab') { // If switching to progress tab, render chart and attendance
                renderBodyweightChart();
                updateAttendanceSummary();
            }
        }
        
        // Displays the workout for the selected workout type
        function displayWorkoutForDay(workoutKey) {
            currentSelectedDayKey = workoutKey; 
            showTab('workoutDayTab'); 

            const displayArea = document.getElementById('workoutDisplayArea');
            const dayTitleElement = document.getElementById('workoutDayTitle');
            
            if (dayTitleElement) { 
                dayTitleElement.textContent = `${workoutKey}`;
            }
            displayArea.innerHTML = `<h2 id="workoutDayTitle">${workoutKey}</h2>`; 
            
            const workoutItems = USER_WORKOUT_PLAN[workoutKey];
            if (!workoutItems) {
                displayArea.innerHTML += "<p>No workout found for this type.</p>";
                renderDailyLog(); 
                return;
            }

            workoutItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('exercise-item');
                let e1RM = exercisesE1RM[item.group || item.liftName] || 0;
                let targetWeight = 0;
                let isBodyweightExercise = BODYWEIGHT_ASSISTED_EXERCISES.includes(item.liftName);

                let content = `<h3>${item.setLabel || item.name || item.liftName}</h3>`;
                if (item.details) content += `<p class="exercise-details">${item.details}</p>`;

                const isLogged = dailyLog[item.id] && dailyLog[item.id].completed;
                const completedMark = isLogged ? ` <span class="completed-marker">✓ Logged</span>` : '';

                if (item.type === 'strength_single_heavy' || item.type === 'strength_volume') {
                    targetWeight = e1RM > 0 && item.percentage ? (e1RM * item.percentage) : 0; // Keep as number for BW calc
                    let repDisplay = item.repsTarget || item.reps;
                    let targetWeightDisplay = targetWeight > 0 ? targetWeight.toFixed(1) : 'N/A (Set e1RM)';
                    
                    if (isBodyweightExercise && e1RM > 0 && userBodyweight > 0) {
                        const targetAddedWeight = targetWeight - userBodyweight;
                        targetWeightDisplay = `BW + ${targetAddedWeight > 0 ? targetAddedWeight.toFixed(1) : '0'} kg/lbs`;
                         if (targetAddedWeight < 0) targetWeightDisplay = `Bodyweight (assisted if needed)`;
                    } else if (isBodyweightExercise && (e1RM <= 0 || userBodyweight <=0)) {
                        targetWeightDisplay = 'N/A (Set e1RM & BW)';
                    }
                    content += `<p class="exercise-details">${item.sets} set(s) of ${repDisplay} reps @ ~${targetWeightDisplay} (target)</p>`;
                } else if (item.type === 'accessory') {
                    let repDetail = item.reps ? `${item.reps} reps` : `${item.repsRange} reps`;
                    content += `<p class="exercise-details">${item.sets} set(s) of ${repDetail}</p>`;
                     if (isBodyweightExercise) {
                        content += `<p class="exercise-details" style="font-style:italic; font-size:0.85em;">(Log added weight only)</p>`;
                    }
                } else if (item.type === 'hiit' || item.type === 'cardio') {
                     content += `<p class="exercise-details">Duration: ${item.duration || ''}, Intensity: ${item.intensity || ''}</p>`;
                }

                if (item.notes) content += `<p class="exercise-notes">${item.notes}</p>`;
                
                if (item.type === 'strength_single_heavy') {
                    let prefillWtValue;
                    if (isBodyweightExercise) {
                        prefillWtValue = dailyLog[item.id]?.actualAddedWeight !== undefined ? dailyLog[item.id]?.actualAddedWeight : 
                                         (e1RM > 0 && userBodyweight > 0 && targetWeight > 0 ? Math.max(0, targetWeight - userBodyweight).toFixed(1) : "0");
                    } else {
                       prefillWtValue = dailyLog[item.id]?.actualWeight !== undefined ? dailyLog[item.id]?.actualWeight : (targetWeight > 0 ? targetWeight.toFixed(1) : '');
                    }
                    const weightLabel = isBodyweightExercise ? "Added Wt:" : "Actual Wt:";
                    content += `
                        <div class="inline-inputs">
                            <label>${weightLabel}</label><input type="number" id="${item.id}_weight" placeholder="Wt" value="${prefillWtValue}">
                            <label>Reps:</label><input type="number" id="${item.id}_reps" placeholder="Reps" value="${dailyLog[item.id]?.actualReps || ''}">
                            <label>RPE:</label><input type="number" id="${item.id}_rpe" step="0.5" min="6" max="10" placeholder="RPE" value="${dailyLog[item.id]?.actualRPE || ''}">
                        </div>
                        <button class="action-button log-set-button" onclick="logHeavyStrengthSet('${item.id}', '${item.group || item.liftName}')" ${isLogged ? 'disabled' : ''}>Log Set</button>
                    `;
                } else if (item.type === 'strength_volume') {
                     for (let i = 1; i <= item.sets; i++) {
                        const setLogged = dailyLog[item.id] && dailyLog[item.id][`set${i}`] && dailyLog[item.id][`set${i}`].completed;
                        const setCompletedMark = setLogged ? ` <span class="completed-marker">✓</span>` : '';
                        const setData = dailyLog[item.id]?.[`set${i}`];
                        
                        let prefillWeightValue;
                        if (isBodyweightExercise) {
                            prefillWeightValue = setData?.actualAddedWeight !== undefined ? setData.actualAddedWeight :
                                                (e1RM > 0 && userBodyweight > 0 && targetWeight > 0 ? Math.max(0, targetWeight - userBodyweight).toFixed(1) : "0");
                        } else {
                            prefillWeightValue = setData?.actualWeight !== undefined ? setData.actualWeight : (targetWeight > 0 ? targetWeight.toFixed(1) : '');
                        }
                        const weightLabel = isBodyweightExercise ? "Added Wt:" : "Actual Wt:";
                        let targetWeightDisplay = targetWeight > 0 ? targetWeight.toFixed(1) : "N/A";
                        if (isBodyweightExercise && e1RM > 0 && userBodyweight > 0 && targetWeight > 0) {
                             const targetAdded = targetWeight - userBodyweight;
                             targetWeightDisplay = `BW + ${targetAdded > 0 ? targetAdded.toFixed(1) : '0'}`;
                             if (targetAdded < 0) targetWeightDisplay = `Bodyweight`;
                        } else if (isBodyweightExercise) {
                            targetWeightDisplay = 'N/A (Set e1RM & BW)';
                        }


                        content += `
                            <div class="inline-inputs" style="margin-top:5px;">
                                <span>Set ${i} (Target: ${item.reps} reps @ ~${targetWeightDisplay}):</span><br>
                                <label>${weightLabel}</label><input type="number" id="${item.id}_set${i}_weight" placeholder="Wt" value="${prefillWeightValue}">
                                <label>Reps:</label><input type="number" id="${item.id}_set${i}_reps" placeholder="Reps" value="${setData?.actualReps || ''}">
                                <label>RPE:</label><input type="number" id="${item.id}_set${i}_rpe" step="0.5" min="6" max="10" placeholder="RPE" value="${setData?.actualRPE || ''}">
                                <button class="action-button log-set-button" style="padding: 5px 8px; font-size:0.8em;" onclick="logGenericSet('${item.id}', '${item.group || item.liftName}', ${i})" ${setLogged ? 'disabled' : ''}>Log Set ${i}</button> ${setCompletedMark}
                            </div>`;
                    }
                } else if (item.type === 'accessory') {
                    content += `<div>`;
                    for (let i = 1; i <= item.sets; i++) {
                        const setLogged = dailyLog[item.id] && dailyLog[item.id][`set${i}`] && dailyLog[item.id][`set${i}`].completed;
                        const setCompletedMark = setLogged ? ` <span class="completed-marker">✓</span>` : '';
                        const setData = dailyLog[item.id]?.[`set${i}`];
                        let logDisplay = '';
                        if(setData) {
                            const loggedWt = isBodyweightExercise ? `BW + ${setData.actualAddedWeight}` : setData.actualWeight;
                            logDisplay = `(Logged: ${loggedWt}x${setData.actualReps}@${setData.actualRPE}RPE)`;
                        }
                        content += `<button class="action-button" style="margin-right:5px; margin-bottom:5px;" onclick="openAccessoryLogModal('${item.id}', '${item.liftName}', ${i})" ${setLogged ? 'disabled' : ''}>Log Set ${i}</button> ${setCompletedMark} <span style="font-size:0.8em;">${logDisplay}</span> <br>`;
                    }
                    content += `</div>`;
                } else if (item.type === 'mobility' || item.type === 'hiit' || item.type === 'cardio') {
                    content += `<button class="action-button" onclick="logActivityAsCompleted('${item.id}')" ${isLogged ? 'disabled' : ''}>Mark Completed</button>`;
                }

                // ----- user notes UI -----
                content += `
                    <label style="display:block; margin-top:10px;">Notes:</label>
                    <textarea id="${item.id}_userNotes"
                              rows="2"
                              style="width:100%; box-sizing:border-box;"
                              placeholder="Add notes...">${dailyLog[item.id]?.userNotes || ''}</textarea>
                    <button class="action-button"
                            style="margin-top:6px; padding:6px 12px; font-size:0.85em;"
                            onclick="saveExerciseNotes('${item.id}')">Save Notes</button>
                `;

                itemDiv.innerHTML = content + completedMark; 
                displayArea.appendChild(itemDiv);
            });
             renderDailyLog(); 
        }

        function logHeavyStrengthSet(itemId, groupName) {
            try {
                const addedWeightInput = parseFloat(document.getElementById(`${itemId}_weight`).value); // This is either total weight or added weight
                const reps = parseInt(document.getElementById(`${itemId}_reps`).value);
                const rpe = parseFloat(document.getElementById(`${itemId}_rpe`).value);

                // Enhanced input validation
                if (isNaN(addedWeightInput) || addedWeightInput < 0) {
                    showError('Please enter a valid weight (0 or positive number)');
                    return;
                }
                if (isNaN(reps) || reps <= 0 || reps > 50) {
                    showError('Please enter valid reps (1-50)');
                    return;
                }
                if (isNaN(rpe) || rpe < 6 || rpe > 10) {
                    showError('Please enter valid RPE (6-10)');
                    return;
                }
                if (BODYWEIGHT_ASSISTED_EXERCISES.includes(groupName) && addedWeightInput < 0) {
                    showError('Added weight for bodyweight exercises cannot be negative. Use 0 for bodyweight only.');
                    return;
                }
            
            let totalWeightLifted = addedWeightInput;
            let actualLoggedWeight = addedWeightInput; // What gets stored as "actualWeight" in log
            let actualLoggedAddedWeight = null;     // Specifically for BW exercises

            if (BODYWEIGHT_ASSISTED_EXERCISES.includes(groupName)) {
                if (userBodyweight <= 0) {
                    alert("Please set your bodyweight in the 'Settings & e1RMs' tab to accurately log this exercise.");
                    return;
                }
                totalWeightLifted = userBodyweight + addedWeightInput;
                actualLoggedAddedWeight = addedWeightInput; // Store the added part
                actualLoggedWeight = totalWeightLifted; // For e1RM calc, use total
            }


            const e1RMAtSetStart = exercisesE1RM[groupName] || 0; 
            const effectiveReps = getEffectiveReps(reps, rpe);
            const e1RMCalcFromSet = calculateEpleyE1RM(totalWeightLifted, effectiveReps);

            let finalGroupE1RM = e1RMAtSetStart;
            if (e1RMCalcFromSet > 0) {
                finalGroupE1RM = Math.max(e1RMAtSetStart, e1RMCalcFromSet);
                if (finalGroupE1RM > e1RMAtSetStart) {
                    e1RMChangeStatus[groupName] = "increased";
                } else if (finalGroupE1RM < e1RMAtSetStart && e1RMAtSetStart !== 0) { 
                    e1RMChangeStatus[groupName] = "decreased";
                } else {
                     delete e1RMChangeStatus[groupName]; 
                }
                exercisesE1RM[groupName] = finalGroupE1RM;
            } else {
                 delete e1RMChangeStatus[groupName]; 
            }

            dailyLog[itemId] = { 
                completed: true, 
                actualWeight: actualLoggedWeight, // Log total weight if BW, else just weight
                actualAddedWeight: actualLoggedAddedWeight, // Log added weight if applicable
                actualReps: reps, 
                actualRPE: rpe, 
                e1RMAtSetStart: e1RMAtSetStart, 
                e1RMCalcFromSet: e1RMCalcFromSet,
                groupE1RMAfterSet: finalGroupE1RM 
            };
            saveData();
            renderE1RMTable(); 
            displayWorkoutForDay(currentSelectedDayKey); 
            alert(`${groupName} set logged. Group e1RM (total load) is now ${finalGroupE1RM.toFixed(1)}.`);
            
            // Auto-start rest timer for main/activation sets
            startRestTimer(180); // 3 minutes for heavy sets
            
            } catch (error) {
                showError('Failed to log set', error.message);
            }
        }

        function logGenericSet(itemId, groupName, setIndex) {
            const addedWeightInput = parseFloat(document.getElementById(`${itemId}_set${setIndex}_weight`).value);
            const reps = parseInt(document.getElementById(`${itemId}_set${setIndex}_reps`).value);
            const rpe = parseFloat(document.getElementById(`${itemId}_set${setIndex}_rpe`).value);
            
            if (isNaN(addedWeightInput) || isNaN(reps) || isNaN(rpe) || reps < 0) { 
                alert(`Please enter valid (added) weight, reps, and RPE for Set ${setIndex}.`);
                return;
            }
            if (BODYWEIGHT_ASSISTED_EXERCISES.includes(groupName) && addedWeightInput < 0) {
                alert('Added weight for bodyweight exercises cannot be negative. Use 0 for bodyweight only.');
                return;
            }

            let totalWeightLifted = addedWeightInput;
            let actualLoggedWeight = addedWeightInput;
            let actualLoggedAddedWeight = null;

            if (BODYWEIGHT_ASSISTED_EXERCISES.includes(groupName)) {
                 if (userBodyweight <= 0) {
                    alert("Please set your bodyweight in the 'Settings & e1RMs' tab to accurately log this exercise.");
                    return;
                }
                totalWeightLifted = userBodyweight + addedWeightInput;
                actualLoggedAddedWeight = addedWeightInput;
                actualLoggedWeight = totalWeightLifted;
            }


            if (!dailyLog[itemId]) dailyLog[itemId] = { completed: false }; 
            if (!dailyLog[itemId][`set${setIndex}`]) dailyLog[itemId][`set${setIndex}`] = {};
            
            dailyLog[itemId][`set${setIndex}`] = { 
                completed: true, 
                actualWeight: actualLoggedWeight, 
                actualAddedWeight: actualLoggedAddedWeight,
                actualReps: reps, 
                actualRPE: rpe 
            };
            
            const planItem = USER_WORKOUT_PLAN[currentSelectedDayKey].find(it => it.id === itemId);
            let allSetsDone = true;
            if (planItem && planItem.sets) {
                for (let i = 1; i <= planItem.sets; i++) {
                    if (!dailyLog[itemId]?.[`set${i}`]?.completed) {
                        allSetsDone = false;
                        break;
                    }
                }
            }
            if(allSetsDone) dailyLog[itemId].completed = true;

            if (CORE_LIFTS_IN_PLAN.includes(groupName)) {
                const e1RMAtSetStart = exercisesE1RM[groupName] || 0;
                const effectiveReps = getEffectiveReps(reps, rpe);
                const e1RMCalcFromSet = calculateEpleyE1RM(totalWeightLifted, effectiveReps);
                if (e1RMCalcFromSet > 0 && e1RMCalcFromSet > e1RMAtSetStart) { 
                    exercisesE1RM[groupName] = e1RMCalcFromSet; 
                    e1RMChangeStatus[groupName] = "increased";
                    dailyLog[itemId][`set${setIndex}`].newGroupE1RM = e1RMCalcFromSet; 
                } 
            }

            saveData();
            renderE1RMTable();
            displayWorkoutForDay(currentSelectedDayKey);
            alert(`${groupName} Set ${setIndex} logged.`);
            
            // Auto-start rest timer for volume sets (shorter rest)
            startRestTimer(120); // 2 minutes for volume sets
        }
        
        function openAccessoryLogModal(itemId, liftName, setIndex) {
            document.getElementById('modalTitle').textContent = `Log Set ${setIndex} for ${liftName}`;
            document.getElementById('modalExerciseName').value = liftName; 
            document.getElementById('modalSetIndex').value = setIndex;     
            document.getElementById('accessoryLogModal').setAttribute('data-item-id', itemId); 

            const weightLabel = document.getElementById('modalWeightLabel');
            if (BODYWEIGHT_ASSISTED_EXERCISES.includes(liftName)) {
                weightLabel.textContent = "Added Weight:";
            } else {
                weightLabel.textContent = "Weight:";
            }

            const existingLog = dailyLog[itemId]?.[`set${setIndex}`];
            let prefillWeight = "";
            if (existingLog) {
                prefillWeight = BODYWEIGHT_ASSISTED_EXERCISES.includes(liftName) ? 
                                (existingLog.actualAddedWeight !== null ? existingLog.actualAddedWeight : '') : 
                                (existingLog.actualWeight !== null ? existingLog.actualWeight : '');
            }

            document.getElementById('modalWeight').value = prefillWeight;
            document.getElementById('modalReps').value = existingLog?.actualReps || '';
            document.getElementById('modalRPE').value = existingLog?.actualRPE || '';
            
            document.getElementById('accessoryLogModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('accessoryLogModal').style.display = 'none';
        }

        function submitAccessorySetLog() {
            const itemId = document.getElementById('accessoryLogModal').getAttribute('data-item-id');
            const liftName = document.getElementById('modalExerciseName').value;
            const setIndex = parseInt(document.getElementById('modalSetIndex').value);
            
            const addedWeightInput = parseFloat(document.getElementById('modalWeight').value); // Value from modal is added weight or total weight
            const reps = parseInt(document.getElementById('modalReps').value);
            const rpe = parseFloat(document.getElementById('modalRPE').value);

            if (isNaN(addedWeightInput) || isNaN(reps) || isNaN(rpe) || reps < 0) {
                alert('Please enter valid (added) weight, reps, and RPE.');
                return;
            }
            if (BODYWEIGHT_ASSISTED_EXERCISES.includes(liftName) && addedWeightInput < 0) {
                alert('Added weight for bodyweight exercises cannot be negative. Use 0 for bodyweight only.');
                return;
            }

            let totalWeightLifted = addedWeightInput;
            let actualLoggedWeight = addedWeightInput;
            let actualLoggedAddedWeight = null;

            if (BODYWEIGHT_ASSISTED_EXERCISES.includes(liftName)) {
                 if (userBodyweight <= 0) {
                    alert("Please set your bodyweight in the 'Settings & e1RMs' tab to accurately log this exercise.");
                    return;
                }
                totalWeightLifted = userBodyweight + addedWeightInput;
                actualLoggedAddedWeight = addedWeightInput;
                actualLoggedWeight = totalWeightLifted; // Store total for consistency in e1RM calc
            }


            if (!dailyLog[itemId]) dailyLog[itemId] = { completed: false };
            if (!dailyLog[itemId][`set${setIndex}`]) dailyLog[itemId][`set${setIndex}`] = {};

            dailyLog[itemId][`set${setIndex}`] = { 
                completed: true, 
                actualWeight: actualLoggedWeight, // Store total weight for consistency
                actualAddedWeight: actualLoggedAddedWeight, // Store added weight for display/editing
                actualReps: reps, 
                actualRPE: rpe 
            };

            const planItem = USER_WORKOUT_PLAN[currentSelectedDayKey].find(it => it.id === itemId);
            let allSetsDone = true;
            if (planItem && planItem.sets) {
                for (let i = 1; i <= planItem.sets; i++) {
                    if (!dailyLog[itemId]?.[`set${i}`]?.completed) {
                        allSetsDone = false;
                        break;
                    }
                }
            }
             if(allSetsDone) dailyLog[itemId].completed = true;

            if (CORE_LIFTS_IN_PLAN.includes(liftName)) {
                const e1RMAtSetStart = exercisesE1RM[liftName] || 0;
                const effectiveReps = getEffectiveReps(reps, rpe);
                const e1RMCalcFromSet = calculateEpleyE1RM(totalWeightLifted, effectiveReps);
                if (e1RMCalcFromSet > 0 && e1RMCalcFromSet > e1RMAtSetStart) { 
                    exercisesE1RM[liftName] = e1RMCalcFromSet;
                    e1RMChangeStatus[liftName] = "increased";
                    dailyLog[itemId][`set${setIndex}`].newGroupE1RM = e1RMCalcFromSet;
                } 
            }
            
            saveData();
            renderE1RMTable();
            displayWorkoutForDay(currentSelectedDayKey);
            closeModal();
            alert(`${liftName} Set ${setIndex} logged.`);
            
            // Auto-start rest timer for accessory sets
            startRestTimer(90); // 1.5 minutes for accessory sets
        }

        function logActivityAsCompleted(itemId) {
            dailyLog[itemId] = { completed: true, loggedAt: new Date().toLocaleTimeString() };
            saveData();
            displayWorkoutForDay(currentSelectedDayKey); 
            alert(`Activity marked as completed.`);
        }

        // ----------  PER-EXERCISE NOTES ----------
        function saveExerciseNotes(itemId) {
            const input = document.getElementById(`${itemId}_userNotes`);
            if (!input) return;

            // guarantee the node exists in dailyLog
            if (!dailyLog[itemId]) dailyLog[itemId] = { completed: false };

            dailyLog[itemId].userNotes = input.value.trim();
            saveData();
            alert('Notes saved.');
        }
        
        function renderDailyLog() {
            const container = document.getElementById('dailyWorkoutLogContainer');
            container.innerHTML = ''; 
            Object.keys(dailyLog).sort().forEach(itemId => { 
                const logItem = dailyLog[itemId];
                const planItem = Object.values(USER_WORKOUT_PLAN).flat().find(p => p.id === itemId);
                let logText = `<strong>${planItem?.setLabel || planItem?.name || planItem?.liftName || itemId}:</strong> `;

                if (logItem.completed === true) {
                    if (logItem.actualReps !== undefined && logItem.e1RMCalcFromSet !== undefined) { // Heavy single set
                        let weightDisplay = logItem.actualWeight;
                        if (logItem.actualAddedWeight !== null) {
                             weightDisplay = `BW + ${logItem.actualAddedWeight}`;
                        }
                        logText += `${weightDisplay}x${logItem.actualReps}@${logItem.actualRPE}RPE. e1RM from set: ${logItem.e1RMCalcFromSet.toFixed(1)}. Group e1RM now: ${logItem.groupE1RMAfterSet.toFixed(1)}.`;
                    } else if (Object.keys(logItem).some(key => key.startsWith('set'))) { 
                        let setsSummary = [];
                        for (let i = 1; i <= (planItem?.sets || 0); i++) {
                            if (logItem[`set${i}`]?.completed) {
                                let currentSet = logItem[`set${i}`];
                                let weightDisplay = currentSet.actualWeight;
                                if (currentSet.actualAddedWeight !== null) {
                                    weightDisplay = `BW + ${currentSet.actualAddedWeight}`;
                                }
                                let setStr = `Set ${i}: ${weightDisplay}x${currentSet.actualReps}@${currentSet.actualRPE}RPE`;
                                if(currentSet.newGroupE1RM) setStr += ` (new e1RM: ${currentSet.newGroupE1RM.toFixed(1)})`;
                                setsSummary.push(setStr);
                            }
                        }
                        logText += setsSummary.join('; ') || "Sets logged.";
                    } else { 
                        logText += `Completed at ${logItem.loggedAt || 'Logged'}.`;
                    }
                } else {
                     logText += "In progress..."; 
                }
                if (logItem.userNotes) {
                    logText += `<br><em>Notes: ${logItem.userNotes}</em>`;
                }
                const p = document.createElement('p');
                p.style.margin = '3px 0';
                p.innerHTML = logText;
                container.appendChild(p);
            });
        }

        function clearDailyLog() {
            if(confirm("Are you sure you want to clear all logs for today? This only affects today's checkmarks and entries, not your e1RMs.")) {
                dailyLog = {};
                saveData(); 
                 if (currentActiveTab === 'workoutDayTab' && currentSelectedDayKey) displayWorkoutForDay(currentSelectedDayKey); 
                 else renderDailyLog(); 
            }
        }

        // Smart Recommendations Functions
        function updateSliderValues() {
            document.getElementById('energyLevelValue').textContent = document.getElementById('energyLevel').value;
            document.getElementById('stressLevelValue').textContent = document.getElementById('stressLevel').value;
        }

        function getRecentWorkoutHistory() {
            const history = [];
            const now = new Date();
            
            // Look back 14 days for workout history
            for (let i = 0; i < 14; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const logData = localStorage.getItem(`personalizedPlanDailyLog_${APP_VERSION_KEY}_${dateStr}`);
                if (logData) {
                    const log = JSON.parse(logData);
                    if (Object.keys(log).length > 0) {
                        // Determine which workout type was done
                        const workoutTypes = Object.values(USER_WORKOUT_PLAN);
                        let workoutType = 'Unknown';
                        
                        for (const [type, exercises] of Object.entries(USER_WORKOUT_PLAN)) {
                            const typeExerciseIds = exercises.map(e => e.id);
                            const logExerciseIds = Object.keys(log);
                            
                            if (typeExerciseIds.some(id => logExerciseIds.includes(id))) {
                                workoutType = type;
                                break;
                            }
                        }
                        
                        history.push({
                            date: dateStr,
                            workoutType: workoutType,
                            exerciseCount: Object.keys(log).length,
                            completedCount: Object.values(log).filter(l => l.completed).length
                        });
                    }
                }
            }
            
            return history;
        }

        // Test API key validity using a CORS proxy
        async function testApiKey() {
            try {
                // Use local proxy server to avoid CORS issues
                const proxyUrl = 'http://localhost:3001/api/anthropic';
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': claudeApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 10,
                        messages: [{
                            role: 'user',
                            content: 'Test'
                        }]
                    })
                });
                
                if (response.ok) {
                    return { valid: true, message: 'API key is valid' };
                } else {
                    const errorData = await response.text();
                    return { valid: false, message: `API key test failed: ${response.status} - ${errorData}` };
                }
            } catch (error) {
                return { 
                    valid: false, 
                    message: `Connection failed: ${error.message}\n\nMake sure the proxy server is running:\n1. Open terminal in this folder\n2. Run: npm install\n3. Run: npm start\n4. Try the API test again` 
                };
            }
        }

        async function getWorkoutRecommendation() {
            if (!claudeApiKey || claudeApiKey.trim() === '') {
                alert('Please set your Claude API key in the Settings & e1RMs tab to use smart recommendations.');
                return;
            }

            // Validate API key format
            if (!claudeApiKey.startsWith('sk-ant-')) {
                alert('Invalid API key format. Claude API keys should start with "sk-ant-"');
                return;
            }

            const btn = document.getElementById('getRecommendationBtn');
            btn.disabled = true;
            btn.textContent = 'Getting recommendation...';

            try {
                // Gather user input
                const energyLevel = document.getElementById('energyLevel').value;
                const stressLevel = document.getElementById('stressLevel').value;
                const musclesSore = document.getElementById('musclesSore').value;
                const timeAvailable = document.getElementById('timeAvailable').value;
                const specificGoals = document.getElementById('specificGoals').value;

                // Get workout history
                const workoutHistory = getRecentWorkoutHistory();

                // Prepare context for Claude
                const prompt = `You are an evidence-based fitness AI following research-backed training principles. Based on the information below, recommend ONE specific workout from the available options and suggest any modifications.

TRAINING PRINCIPLES TO FOLLOW:
- Consistency beats perfection
- Progressive overload: gradually increase load/volume
- Strength training: ≥85% 1RM, 1-5 reps, 2-5min rest, stop 3-4 reps shy of failure
- Hypertrophy: 60-80% 1RM, 6-12 reps, 1-2min rest, can train closer to failure on isolation
- Frequency: 2-3x per muscle group per week for optimal gains
- Recovery: adequate rest between sessions, prioritize sleep
- 80/20 rule for cardio: 80% low/moderate intensity, 20% high intensity

AVAILABLE WORKOUT TYPES:
${Object.keys(USER_WORKOUT_PLAN).map(type => `- ${type}: ${USER_WORKOUT_PLAN[type].map(ex => ex.liftName || ex.name).join(', ')}`).join('\n')}

USER'S CURRENT STATE:
- Energy Level: ${energyLevel}/10
- Stress Level: ${stressLevel}/10
- Muscle soreness/fatigue: ${musclesSore || 'None mentioned'}
- Time available: ${timeAvailable} minutes
- Specific goals: ${specificGoals || 'None mentioned'}
- Current bodyweight: ${userBodyweight}kg
- Current e1RMs: ${Object.entries(exercisesE1RM).map(([lift, e1rm]) => `${lift}: ${e1rm.toFixed(1)}kg`).join(', ')}

RECENT WORKOUT HISTORY (last 14 days):
${workoutHistory.length > 0 ? 
    workoutHistory.map(h => `${h.date}: ${h.workoutType} (${h.completedCount}/${h.exerciseCount} exercises completed)`).join('\n') : 
    'No recent workouts logged'}

Consider muscle group frequency, recovery needs, training intensity distribution, and progressive overload when making your recommendation.

Please respond in this exact format:
RECOMMENDATION: [Workout Type]
REASONING: [Brief explanation based on training principles and user state]
MODIFICATIONS: [Specific changes to sets, reps, intensity, or RPE based on evidence-based guidelines]

Keep your response concise and practical.`;

                // Use local proxy server to avoid browser CORS restrictions
                const proxyUrl = 'http://localhost:3001/api/anthropic';
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': claudeApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('API Error Response:', errorData);
                    throw new Error(`API request failed: ${response.status} - ${errorData}`);
                }

                const data = await response.json();
                
                // Validate response structure
                if (!data.content || !data.content[0] || !data.content[0].text) {
                    console.error('Invalid API response structure:', data);
                    throw new Error('Invalid response structure from API');
                }
                
                const recommendation = data.content[0].text;

                // Parse recommendation
                const lines = recommendation.split('\n');
                const recommendationLine = lines.find(l => l.startsWith('RECOMMENDATION:'));
                const reasoningLine = lines.find(l => l.startsWith('REASONING:'));
                const modificationsLine = lines.find(l => l.startsWith('MODIFICATIONS:'));

                const workoutType = recommendationLine ? recommendationLine.replace('RECOMMENDATION:', '').trim() : 'Squat Day';
                const reasoning = reasoningLine ? reasoningLine.replace('REASONING:', '').trim() : 'AI recommendation based on your current state.';
                const modifications = modificationsLine ? modificationsLine.replace('MODIFICATIONS:', '').trim() : 'Follow the standard workout plan.';

                currentRecommendation = {
                    workoutType: workoutType,
                    reasoning: reasoning,
                    modifications: modifications
                };

                // Display recommendation
                document.getElementById('recommendationContent').innerHTML = `
                    <div style="background-color: var(--md-purple-100); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: var(--md-purple-700);">Recommended Workout: ${workoutType}</h4>
                        <p><strong>Why this workout:</strong> ${reasoning}</p>
                        <p><strong>Suggested modifications:</strong> ${modifications}</p>
                    </div>
                `;

                document.getElementById('recommendationResult').style.display = 'block';

            } catch (error) {
                console.error('Error getting recommendation:', error);
                
                // More detailed error message
                let errorMessage = 'Failed to get workout recommendation.\n\n';
                
                if (error.message.includes('401')) {
                    errorMessage += 'Authentication failed - please check your API key.';
                } else if (error.message.includes('429')) {
                    errorMessage += 'Rate limit exceeded - please try again later.';
                } else if (error.message.includes('400')) {
                    errorMessage += 'Bad request - there may be an issue with the request format.';
                } else if (error.message.includes('network') || error.message.includes('fetch') || error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    errorMessage += 'Connection to proxy server failed.\n\n';
                    errorMessage += 'Setup steps:\n';
                    errorMessage += '1. Open terminal in this folder\n';
                    errorMessage += '2. Run: npm install\n';
                    errorMessage += '3. Run: npm start\n';
                    errorMessage += '4. Refresh this page and try again\n\n';
                    errorMessage += 'Or use the simple built-in recommendation system instead?';
                    
                    if (confirm(errorMessage)) {
                        generateSimpleRecommendation();
                        return;
                    }
                } else {
                    errorMessage += `Error details: ${error.message}`;
                }
                
                errorMessage += '\n\nPlease check the browser console for more details.';
                
                alert(errorMessage);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Get Smart Recommendation';
            }
        }

        function acceptRecommendation() {
            if (currentRecommendation && currentRecommendation.workoutType) {
                displayWorkoutForDay(currentRecommendation.workoutType);
                alert(`Starting ${currentRecommendation.workoutType}! Remember: ${currentRecommendation.modifications}`);
            }
        }

        // Simple built-in recommendation system (fallback when Claude API fails)
        function generateSimpleRecommendation() {
            const energyLevel = parseInt(document.getElementById('energyLevel').value);
            const stressLevel = parseInt(document.getElementById('stressLevel').value);
            const musclesSore = document.getElementById('musclesSore').value.toLowerCase();
            const timeAvailable = parseInt(document.getElementById('timeAvailable').value);
            
            // Get recent workout history
            const workoutHistory = getRecentWorkoutHistory();
            const recentWorkouts = workoutHistory.slice(0, 3).map(h => h.workoutType);
            
            let workoutType;
            let reasoning;
            let modifications = '';
            
            // Simple logic-based recommendations
            if (energyLevel <= 4 || stressLevel >= 8) {
                if (timeAvailable < 45) {
                    workoutType = 'Mobility Day';
                    reasoning = 'Low energy/high stress suggests recovery focus. Light mobility work will help.';
                } else {
                    workoutType = 'Cardio Day';
                    reasoning = 'Low energy/high stress. Zone 2 cardio is great for stress relief without overtaxing.';
                }
            } else if (musclesSore.includes('leg') || musclesSore.includes('squat')) {
                if (!recentWorkouts.includes('Pull Day')) {
                    workoutType = 'Pull Day';
                    reasoning = 'Legs are sore, so focusing on upper body pulling movements.';
                } else {
                    workoutType = 'Bench Day';
                    reasoning = 'Legs are sore, and you haven\'t done bench recently.';
                }
            } else if (musclesSore.includes('upper') || musclesSore.includes('shoulder') || musclesSore.includes('chest')) {
                workoutType = 'Squat Day';
                reasoning = 'Upper body is sore, so focusing on lower body strength.';
            } else if (timeAvailable < 45) {
                // Quick workout options
                if (!recentWorkouts.includes('Pull Day')) {
                    workoutType = 'Pull Day';
                    reasoning = 'Limited time, and pull work is efficient and needed.';
                } else {
                    workoutType = 'Mobility Day';
                    reasoning = 'Limited time suggests a quick mobility session.';
                }
            } else {
                // Normal energy, look at what hasn't been done recently
                const workoutOptions = ['Squat Day', 'Bench Day', 'Deadlift Day', 'Pull Day'];
                const undoneworkouts = workoutOptions.filter(w => !recentWorkouts.includes(w));
                
                if (undoneworkouts.length > 0) {
                    workoutType = undoneworkouts[0];
                    reasoning = `Good energy levels and you haven't done ${workoutType} recently.`;
                } else {
                    workoutType = 'Squat Day';
                    reasoning = 'Good energy levels. Squat day is always a solid choice for lower body strength.';
                }
            }
            
            // Evidence-based modifications 
            if (energyLevel <= 6) {
                modifications = 'Reduce intensity to 70-80% 1RM. Stay 4-5 reps from failure on strength moves (RPE 6-7). Prioritize form and recovery.';
            } else if (energyLevel >= 8 && stressLevel <= 4) {
                modifications = 'Good energy! Work at 85-90% 1RM for strength moves. Can train closer to failure (RPE 8-9) on isolation exercises.';
            } else {
                modifications = 'Work at planned intensities. Stay 3-4 reps from failure on compound movements.';
            }
            
            if (timeAvailable < 60) {
                modifications += ' Use 1-2min rest periods. Focus on main compound movements only. Consider supersets for accessories.';
            } else if (timeAvailable >= 90) {
                modifications += ' Take full 2-5min rest between strength sets. Add extra warm-up and cool-down time.';
            }
            
            // Frequency considerations
            const daysSinceLastWorkout = workoutHistory.length > 0 ? 
                (new Date() - new Date(workoutHistory[0].date)) / (1000 * 60 * 60 * 24) : 7;
            
            if (daysSinceLastWorkout > 3) {
                modifications += ' Start conservatively after rest period - reduce loads by 10%.';
            }
            
            currentRecommendation = {
                workoutType: workoutType,
                reasoning: reasoning,
                modifications: modifications
            };
            
            // Display recommendation
            document.getElementById('recommendationContent').innerHTML = `
                <div style="background-color: var(--md-purple-100); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; color: var(--md-purple-700);">Recommended Workout: ${workoutType}</h4>
                    <p><strong>Why this workout:</strong> ${reasoning}</p>
                    <p><strong>Suggested modifications:</strong> ${modifications}</p>
                    <p style="font-size: 0.85em; color: var(--md-grey-700);"><em>Generated by built-in recommendation system</em></p>
                </div>
            `;
            
            document.getElementById('recommendationResult').style.display = 'block';
        }

        // Data Export/Import Functions
        function exportData() {
            try {
                const exportData = {
                    version: APP_VERSION_KEY,
                    exportDate: new Date().toISOString(),
                    exercisesE1RM: exercisesE1RM,
                    e1RMChangeStatus: e1RMChangeStatus,
                    userBodyweight: userBodyweight,
                    bodyweightHistory: bodyweightHistory,
                    claudeApiKey: claudeApiKey,
                    dailyLogs: {}
                };

                // Export all daily logs
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(`personalizedPlanDailyLog_${APP_VERSION_KEY}_`)) {
                        const date = key.substring(`personalizedPlanDailyLog_${APP_VERSION_KEY}_`.length);
                        exportData.dailyLogs[date] = JSON.parse(localStorage.getItem(key));
                    }
                }

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `fitness-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                const statusDiv = document.getElementById('dataManagementStatus');
                statusDiv.textContent = `Data exported successfully at ${new Date().toLocaleTimeString()}`;
                statusDiv.style.color = 'var(--md-green-500)';
                
            } catch (error) {
                console.error('Export error:', error);
                const statusDiv = document.getElementById('dataManagementStatus');
                statusDiv.textContent = 'Export failed. Check console for details.';
                statusDiv.style.color = 'var(--md-red-500)';
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate import data structure
                    if (!importedData.version || !importedData.exportDate) {
                        throw new Error('Invalid backup file format');
                    }

                    const confirmMessage = `Import data from ${new Date(importedData.exportDate).toLocaleDateString()}?\n\nThis will overwrite your current data. Make sure you've exported your current data first!`;
                    
                    if (confirm(confirmMessage)) {
                        // Import core data
                        if (importedData.exercisesE1RM) {
                            exercisesE1RM = importedData.exercisesE1RM;
                        }
                        if (importedData.e1RMChangeStatus) {
                            e1RMChangeStatus = importedData.e1RMChangeStatus;
                        }
                        if (importedData.userBodyweight) {
                            userBodyweight = importedData.userBodyweight;
                            document.getElementById('currentBodyweight').value = userBodyweight;
                        }
                        if (importedData.bodyweightHistory) {
                            bodyweightHistory = importedData.bodyweightHistory;
                        }
                        if (importedData.claudeApiKey) {
                            claudeApiKey = importedData.claudeApiKey;
                            document.getElementById('claudeApiKey').value = claudeApiKey;
                        }

                        // Import daily logs
                        if (importedData.dailyLogs) {
                            // Clear existing daily logs first
                            const keysToRemove = [];
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key && key.startsWith(`personalizedPlanDailyLog_${APP_VERSION_KEY}_`)) {
                                    keysToRemove.push(key);
                                }
                            }
                            keysToRemove.forEach(key => localStorage.removeItem(key));

                            // Import new daily logs
                            Object.entries(importedData.dailyLogs).forEach(([date, logData]) => {
                                localStorage.setItem(`personalizedPlanDailyLog_${APP_VERSION_KEY}_${date}`, JSON.stringify(logData));
                            });
                        }

                        // Update today's daily log if it exists in import
                        if (importedData.dailyLogs && importedData.dailyLogs[todayKey]) {
                            dailyLog = importedData.dailyLogs[todayKey];
                        }

                        // Save all data and refresh UI
                        saveData();
                        renderE1RMTable();
                        renderBodyweightChart();
                        updateAttendanceSummary();
                        if (currentActiveTab === 'workoutDayTab' && currentSelectedDayKey) {
                            displayWorkoutForDay(currentSelectedDayKey);
                        } else {
                            renderDailyLog();
                        }

                        const statusDiv = document.getElementById('dataManagementStatus');
                        statusDiv.textContent = `Data imported successfully from ${new Date(importedData.exportDate).toLocaleDateString()}`;
                        statusDiv.style.color = 'var(--md-green-500)';
                    }
                    
                } catch (error) {
                    console.error('Import error:', error);
                    const statusDiv = document.getElementById('dataManagementStatus');
                    statusDiv.textContent = 'Import failed. Please check the file format.';
                    statusDiv.style.color = 'var(--md-red-500)';
                    alert('Import failed. Please make sure you selected a valid backup file.');
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // Rest Timer Functions
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            if (restTimerSeconds <= 0) {
                display.textContent = '0:00';
                display.style.color = 'var(--md-red-500)';
                if (restTimerInterval) {
                    clearInterval(restTimerInterval);
                    restTimerInterval = null;
                    
                    // Timer finished - play notification and show alert
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Rest Timer Complete!', {
                            body: 'Time to start your next set',
                            icon: '/favicon.ico'
                        });
                    }
                    
                    // Visual/audio notification
                    alert('Rest time complete! Ready for your next set?');
                    
                    // Reset timer state
                    restTimerSeconds = 0;
                    restTimerPaused = false;
                    document.getElementById('startTimerBtn').textContent = 'Start';
                }
            } else {
                display.textContent = formatTime(restTimerSeconds);
                // Color coding: green > 60s, yellow 30-60s, red < 30s
                if (restTimerSeconds > 60) {
                    display.style.color = 'var(--md-green-500)';
                } else if (restTimerSeconds > 30) {
                    display.style.color = 'orange';
                } else {
                    display.style.color = 'var(--md-red-500)';
                }
            }
        }

        function startRestTimer(seconds = null) {
            // Request notification permission on first use
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            if (seconds !== null) {
                // Starting with preset time
                restTimerSeconds = seconds;
                restTimerTotalSeconds = seconds;
            } else if (restTimerSeconds <= 0) {
                // Starting fresh with default time
                restTimerSeconds = 120; // Default 2 minutes
                restTimerTotalSeconds = 120;
            }
            // If seconds is null and restTimerSeconds > 0, we're resuming

            if (restTimerInterval) {
                clearInterval(restTimerInterval);
            }

            restTimerInterval = setInterval(() => {
                if (!restTimerPaused) {
                    restTimerSeconds--;
                    updateTimerDisplay();
                }
            }, 1000);

            restTimerPaused = false;
            document.getElementById('startTimerBtn').textContent = 'Resume';
            showRestTimer();
            updateTimerDisplay();
        }

        function pauseRestTimer() {
            restTimerPaused = !restTimerPaused;
            document.getElementById('pauseTimerBtn').textContent = restTimerPaused ? 'Resume' : 'Pause';
        }

        function stopRestTimer() {
            if (restTimerInterval) {
                clearInterval(restTimerInterval);
                restTimerInterval = null;
            }
            restTimerSeconds = 0;
            restTimerPaused = false;
            document.getElementById('startTimerBtn').textContent = 'Start';
            document.getElementById('pauseTimerBtn').textContent = 'Pause';
            updateTimerDisplay();
        }

        function startCustomTimer() {
            const minutes = parseInt(document.getElementById('customTimerMinutes').value);
            if (minutes && minutes > 0) {
                startRestTimer(minutes * 60);
                document.getElementById('customTimerMinutes').value = '';
            }
        }

        function showRestTimer() {
            document.getElementById('restTimer').classList.add('active');
            document.getElementById('toggleTimerBtn').textContent = 'Hide';
        }

        function hideRestTimer() {
            document.getElementById('restTimer').classList.remove('active');
            document.getElementById('toggleTimerBtn').textContent = 'Show';
        }

        function toggleRestTimer() {
            const timer = document.getElementById('restTimer');
            if (timer.classList.contains('active')) {
                hideRestTimer();
            } else {
                showRestTimer();
            }
        }

        function init() {
            loadData(); 
            const nav = document.getElementById('mainNav');
            const progressButton = nav.querySelector('button[data-tab="progressTab"]'); // Create progress button first
            const e1rmButton = nav.querySelector('button[data-tab="e1rmTab"]'); 

            Object.keys(USER_WORKOUT_PLAN).forEach(workoutKey => {
                const button = document.createElement('button');
                button.textContent = workoutKey; 
                button.setAttribute('data-day-key', workoutKey); 
                button.setAttribute('data-tab', 'workoutDayTab'); 
                button.onclick = () => displayWorkoutForDay(workoutKey);
                nav.insertBefore(button, progressButton); // Insert workout buttons before progress button
            });
            
            document.getElementById('logBodyweightDate').value = todayKey; // Set default date for BW log
            renderE1RMTable(); 
            document.getElementById('currentDateDisplay').textContent = new Date(todayKey).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            renderDailyLog(); 
            renderBodyweightChart();
            updateAttendanceSummary();

            // Add event listeners for sliders
            document.getElementById('energyLevel').addEventListener('input', updateSliderValues);
            document.getElementById('stressLevel').addEventListener('input', updateSliderValues);
            updateSliderValues(); // Initial update

            // Start with the guide tab instead of auto-selecting a workout
            showTab('guideTab'); 
        }

        window.onclick = function(event) { 
            const modal = document.getElementById('accessoryLogModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            showError('Unexpected error occurred', event.error?.message || event.message);
        });

        window.addEventListener('unhandledrejection', function(event) {
            showError('Promise rejection', event.reason?.message || event.reason);
        });

        // Initialize app
        try {
            init();
        } catch (error) {
            showError('Failed to initialize app', error.message);
        }
    </script>
</body>
</html>
